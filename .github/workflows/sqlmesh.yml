name: SQLMesh CI

on:
  push:
    branches: ["main"]
  pull_request:
    branches: ["main"]

jobs:
  sqlmesh:
    runs-on: self-hosted

    # Set Postgres env vars for all steps in this job
    env:
      SQLMESH__POSTGRES__HOST: ${{ secrets.POSTGRES_HOST }}
      SQLMESH__POSTGRES__PORT: ${{ secrets.POSTGRES_PORT }}
      SQLMESH__POSTGRES__DBNAME: ${{ secrets.POSTGRES_DB }}
      SQLMESH__POSTGRES__USER: ${{ secrets.POSTGRES_USER }}
      SQLMESH__POSTGRES__PASSWORD: ${{ secrets.POSTGRES_PASSWORD }}

    defaults:
      run:
        shell: bash
        working-directory: /mnt/c/Users/josh/analytics

    steps:
      - name: Checkout repo
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.11"

      - name: Upgrade pip
        run: python -m pip install --upgrade pip

      - name: Install dependencies
        run: |
          pip install "sqlmesh[postgres]==0.209.0"
          # add any extra dependencies here, e.g., dbt, bigquery, etc.

      - name: Run SQLMesh Plan
        run: sqlmesh plan staging --no-prompts --skip-backfill --verbose

      - name: Run SQLMesh Tests
        run: sqlmesh test
