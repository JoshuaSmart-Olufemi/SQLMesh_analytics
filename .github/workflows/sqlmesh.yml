name: SQLMesh CI

on:
  push:
    branches: ["main"]
  pull_request:
    branches: ["main"]

jobs:
  sqlmesh:
    runs-on: self-hosted

    # --- Postgres connection environment variables ---
    env:
      SQLMESH__POSTGRES__HOST: 172.20.0.1
      SQLMESH__POSTGRES__PORT: 5432
      SQLMESH__POSTGRES__USER: postgres
      SQLMESH__POSTGRES__PASSWORD: postgres
      SQLMESH__POSTGRES__DATABASE: analytics

    defaults:
      run:
        shell: bash
        working-directory: /mnt/c/Users/josh/analytics

    steps:
      - name: Checkout repo
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.11"

      - name: Upgrade pip
        run: python -m pip install --upgrade pip

      - name: Install dependencies
        run: |
          pip install sqlmesh==0.209.0
          # add any extra deps here, e.g. dbt, bigquery, etc.

      - name: Run SQLMesh Plan
        run: sqlmesh plan staging --no-prompts --skip-backfill --verbose

      - name: Run SQLMesh Tests
        run: sqlmesh test
