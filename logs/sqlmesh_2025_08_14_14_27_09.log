2025-08-14 14:27:21,124 - MainThread - sqlmesh.core.config.connection - INFO - Creating new DuckDB adapter for in-memory database (connection.py:483)
2025-08-14 14:27:36,351 - MainThread - sqlmesh.core.plan.evaluator - INFO - Evaluating plan stage PhysicalLayerUpdateStage (evaluator.py:125)
2025-08-14 14:27:36,365 - ThreadPoolExecutor-1_0 - sqlmesh.core.snapshot.evaluator - INFO - Listing data objects in schema analytics.sqlmesh__sqlmesh_example (evaluator.py:361)
2025-08-14 14:27:36,366 - ThreadPoolExecutor-1_1 - sqlmesh.core.snapshot.evaluator - INFO - Listing data objects in schema analytics.sqlmesh__staging (evaluator.py:361)
2025-08-14 14:27:36,367 - ThreadPoolExecutor-1_2 - sqlmesh.core.snapshot.evaluator - INFO - Listing data objects in schema analytics.sqlmesh__analytics (evaluator.py:361)
2025-08-14 14:27:36,368 - ThreadPoolExecutor-1_3 - sqlmesh.core.snapshot.evaluator - INFO - Listing data objects in schema analytics.sqlmesh__raw (evaluator.py:361)
2025-08-14 14:27:36,487 - ThreadPoolExecutor-1_0 - sqlmesh.core.engine_adapter.base - INFO - Executing SQL: /* SQLMESH_PLAN: 2e2fc4fd812949d18a2bc297369c8dfc */ SELECT
  current_catalog (base.py:2260)
2025-08-14 14:27:36,576 - ThreadPoolExecutor-1_1 - sqlmesh.core.engine_adapter.base - INFO - Executing SQL: /* SQLMESH_PLAN: 2e2fc4fd812949d18a2bc297369c8dfc */ SELECT
  current_catalog (base.py:2260)
2025-08-14 14:27:36,658 - ThreadPoolExecutor-1_2 - sqlmesh.core.engine_adapter.base - INFO - Executing SQL: /* SQLMESH_PLAN: 2e2fc4fd812949d18a2bc297369c8dfc */ SELECT
  current_catalog (base.py:2260)
2025-08-14 14:27:36,742 - ThreadPoolExecutor-1_3 - sqlmesh.core.engine_adapter.base - INFO - Executing SQL: /* SQLMESH_PLAN: 2e2fc4fd812949d18a2bc297369c8dfc */ SELECT
  current_catalog (base.py:2260)
2025-08-14 14:27:36,802 - MainThread - sqlmesh.core.plan.evaluator - INFO - Evaluating plan stage BackfillStage (evaluator.py:125)
2025-08-14 14:27:36,924 - ThreadPoolExecutor-2_0 - sqlmesh.core.snapshot.evaluator - INFO - Evaluating snapshot SnapshotId<"analytics"."staging"."stg_events": 387208512> (evaluator.py:648)
2025-08-14 14:27:37,050 - ThreadPoolExecutor-2_0 - sqlmesh.core.snapshot.evaluator - INFO - Inserting batch (2025-08-10 00:00:00, 2025-08-13 00:00:00) into analytics.sqlmesh__staging.staging__stg_events__3222761726' (evaluator.py:703)
2025-08-14 14:27:37,056 - ThreadPoolExecutor-2_0 - sqlmesh.core.engine_adapter.base - INFO - Executing SQL: /* SQLMESH_PLAN: 2e2fc4fd812949d18a2bc297369c8dfc */ SELECT
  1
FROM "information_schema"."tables"
WHERE
  "table_name" = 'staging__stg_events__3222761726'
  AND "table_schema" = 'sqlmesh__staging' (base.py:2260)
2025-08-14 14:27:37,072 - ThreadPoolExecutor-2_0 - sqlmesh.core.snapshot.evaluator - INFO - Skipping creation of the view 'analytics.sqlmesh__staging.staging__stg_events__3222761726' (evaluator.py:1934)
2025-08-14 14:27:37,074 - ThreadPoolExecutor-2_0 - sqlmesh.core.snapshot.evaluator - INFO - Auditing snapshot SnapshotId<"analytics"."staging"."stg_events": 387208512> (evaluator.py:553)
2025-08-14 14:27:37,081 - ThreadPoolExecutor-2_0 - sqlmesh.core.engine_adapter.base - INFO - Executing SQL: /* SQLMESH_PLAN: 2e2fc4fd812949d18a2bc297369c8dfc */ SELECT
  "attname" AS "column_name",
  "pg_catalog".format_type("atttypid", "atttypmod") AS "data_type"
FROM "pg_catalog"."pg_attribute"
JOIN "pg_catalog"."pg_class"
  ON "pg_class"."oid" = "attrelid"
JOIN "pg_catalog"."pg_namespace"
  ON "pg_namespace"."oid" = "relnamespace"
WHERE
  (
    "attnum" > 0
    AND NOT "attisdropped"
    AND "relname" = 'staging__stg_events__3222761726'
  )
  AND "nspname" = 'sqlmesh__staging' (base.py:2260)
2025-08-14 14:27:37,119 - ThreadPoolExecutor-2_0 - sqlmesh.core.engine_adapter.base - INFO - Executing SQL: /* SQLMESH_PLAN: 2e2fc4fd812949d18a2bc297369c8dfc */ SELECT
  COUNT(*)
FROM (
  SELECT
    *
  FROM (
    SELECT
      ROW_NUMBER() OVER (PARTITION BY "event_id" ORDER BY "event_id" NULLS FIRST) AS "rank_event_id",
      ROW_NUMBER() OVER (PARTITION BY "user_id" ORDER BY "user_id" NULLS FIRST) AS "rank_user_id",
      ROW_NUMBER() OVER (PARTITION BY "event_date" ORDER BY "event_date" NULLS FIRST) AS "rank_event_date"
    FROM "analytics"."sqlmesh__staging"."staging__stg_events__3222761726" AS "staging__stg_events__3222761726"
    WHERE
      TRUE
  ) AS "_q_0"
  WHERE
    "rank_event_id" > 1 OR "rank_user_id" > 1 OR "rank_event_date" > 1
) AS "audit" (base.py:2260)
2025-08-14 14:27:37,134 - ThreadPoolExecutor-2_0 - sqlmesh.core.engine_adapter.base - INFO - Executing SQL: /* SQLMESH_PLAN: 2e2fc4fd812949d18a2bc297369c8dfc */ SELECT
  "attname" AS "column_name",
  "pg_catalog".format_type("atttypid", "atttypmod") AS "data_type"
FROM "pg_catalog"."pg_attribute"
JOIN "pg_catalog"."pg_class"
  ON "pg_class"."oid" = "attrelid"
JOIN "pg_catalog"."pg_namespace"
  ON "pg_namespace"."oid" = "relnamespace"
WHERE
  (
    "attnum" > 0
    AND NOT "attisdropped"
    AND "relname" = 'staging__stg_events__3222761726'
  )
  AND "nspname" = 'sqlmesh__staging' (base.py:2260)
2025-08-14 14:27:37,158 - ThreadPoolExecutor-2_0 - sqlmesh.core.engine_adapter.base - INFO - Executing SQL: /* SQLMESH_PLAN: 2e2fc4fd812949d18a2bc297369c8dfc */ SELECT
  COUNT(*)
FROM (
  SELECT
    *
  FROM "analytics"."sqlmesh__staging"."staging__stg_events__3222761726" AS "staging__stg_events__3222761726"
  WHERE
    (
      "event_id" IS NULL OR "user_id" IS NULL OR "event_date" IS NULL
    ) AND TRUE
) AS "audit" (base.py:2260)
2025-08-14 14:27:37,164 - MainThread - sqlmesh.core.scheduler - INFO - Execution failed for node ('"analytics"."staging"."stg_events"', ((1754784000000, 1755043200000), 0)) (scheduler.py:499)
Traceback (most recent call last):
  File "/mnt/c/Users/josh/venv/lib/python3.10/site-packages/sqlmesh/utils/concurrency.py", line 69, in _process_node
    self.fn(node)
  File "/mnt/c/Users/josh/venv/lib/python3.10/site-packages/sqlmesh/core/scheduler.py", line 457, in evaluate_node
    audit_results = self.evaluate(
  File "/mnt/c/Users/josh/venv/lib/python3.10/site-packages/sqlmesh/core/scheduler.py", line 199, in evaluate
    audit_results = self._audit_snapshot(
  File "/mnt/c/Users/josh/venv/lib/python3.10/site-packages/sqlmesh/core/scheduler.py", line 726, in _audit_snapshot
    raise NodeAuditsErrors(audit_errors_to_raise)
sqlmesh.utils.errors.NodeAuditsErrors: Audits failed: unique_values

The above exception was the direct cause of the following exception:

sqlmesh.utils.concurrency.NodeExecutionFailedError: Execution failed for node ('"analytics"."staging"."stg_events"', ((1754784000000, 1755043200000), 0))
2025-08-14 14:27:37,210 - MainThread - sqlmesh.core.context - INFO - Plan application failed. (context.py:1702)
Traceback (most recent call last):
  File "/mnt/c/Users/josh/venv/lib/python3.10/site-packages/sqlmesh/core/context.py", line 1694, in apply
    self._apply(plan, circuit_breaker)
  File "/mnt/c/Users/josh/venv/lib/python3.10/site-packages/sqlmesh/core/context.py", line 2487, in _apply
    self._scheduler.create_plan_evaluator(self).evaluate(
  File "/mnt/c/Users/josh/venv/lib/python3.10/site-packages/sqlmesh/core/plan/evaluator.py", line 107, in evaluate
    self._evaluate_stages(plan_stages, plan)
  File "/mnt/c/Users/josh/venv/lib/python3.10/site-packages/sqlmesh/core/plan/evaluator.py", line 127, in _evaluate_stages
    handler(stage, plan)
  File "/mnt/c/Users/josh/venv/lib/python3.10/site-packages/sqlmesh/core/plan/evaluator.py", line 254, in visit_backfill_stage
    raise PlanError("Plan application failed.")
sqlmesh.utils.errors.PlanError: Plan application failed.
2025-08-14 14:27:37,217 - MainThread - root - INFO - Shutting down the event dispatcher (dispatcher.py:159)
